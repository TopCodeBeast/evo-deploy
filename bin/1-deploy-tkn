#!/usr/bin/env bash

set -e

. $(PWD)/bin/init

tokens=("GOLD" "WOOD" "HHO" "FIRE" "SIOO" "RING" "KTON")

for token in "${tokens[@]}"; do
    address=$(dapp create $token)
    cat $ADDRESSES_FILE | jq --arg key "TOKEN_ERC20_$token" --arg value "$address" '.[$key] = $value' | sponge $ADDRESSES_FILE
    setting=$token
    if [[ "$setting" = "HHO" ]]; then
	setting="WATER"
    fi
    if [[ "$setting" = "SIOO" ]]; then
	setting="SOIL"
    fi
    id="CONTRACT_${setting}_ERC20_TOKEN"
    echo $id
    id=$(seth --to-bytes32 $(seth --to-hex $(seth --from-ascii $id)))
    echo $id
    seth send $SETTINGSREGISTRY "setAddressProperty(bytes32,address)" $id $address 
    if test $(seth call $SETTINGSREGISTRY "addressOf(bytes32)(address)" $id) != $address; then
      (echo "check register ${registry} failed."; exit 1;)
    fi
done
