#!/usr/bin/env bash

set -e

. $(PWD)/bin/init

# ClockAuctionV2
CLOCKAUCTIONV2=$(dapp create ClockAuctionV2)
cat $ADDRESSES_FILE | jq --arg key "CLOCKAUCTIONV2" --arg value "$CLOCKAUCTIONV2" '.[$key] = $value' | sponge $ADDRESSES_FILE

CLOCKAUCTION_PROXY=$(dapp create ClockAuctionProxy)
cat $ADDRESSES_FILE | jq --arg key "CLOCKAUCTION_PROXY" --arg value "$CLOCKAUCTION_PROXY" '.[$key] = $value' | sponge $ADDRESSES_FILE
echo >&2 "${0##*/}: info: ClockAuctionProxy created."

calldata=$(seth calldata "initializeContract(address)" $SETTINGSREGISTRY)
seth send $CLOCKAUCTION_PROXY "upgradeToAndCall(address,bytes)" $CLOCKAUCTIONV2 $calldata 

echo >&2 "${0##*/}: info: ClockAuctionProxy inited."

auctionId=$(seth --to-bytes32 $(seth --to-hex $(seth --from-ascii "CONTRACT_CLOCK_AUCTION")))
seth send $SETTINGSREGISTRY "setAddressProperty(bytes32,address)" $auctionId $CLOCKAUCTION_PROXY 
