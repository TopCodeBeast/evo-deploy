#!/usr/bin/env bash

set -e

. $(PWD)/bin/init

LANDBASEV2=$(dappCreate land contracts/LandBaseV2.sol:LandBaseV2)
info "LandBaseV2 created."

LANDBASE_PROXY=$(dappProxy src/proxy/LandBaseProxy.sol:LandBaseProxy)
info "LandBaseProxy created."

xLow=$(seth --to-int256 -67)
xHigh=$(seth --to-int256 -23)
yLow=$(seth --to-int256 -22)
yHigh=$(seth --to-int256 22)
seth send $LANDBASE_PROXY "upgradeTo(address)" $LANDBASEV2  
seth send $LANDBASE_PROXY "initializeContract(address,int256,int256,int256,int256)" $SETTINGSREGISTRY $xLow $xHigh $yLow $yHigh
info "LandBaseProxy inited."

seth send $INTERSTELLARENCODERV4 "registerNewObjectClass(address,uint8)" $LANDBASE_PROXY $(seth --to-hex 1) 

landBaseId=$(seth --to-bytes32 $(seth --from-ascii "CONTRACT_LAND_BASE"))
seth send $SETTINGSREGISTRY "setAddressProperty(bytes32,address)" $landBaseId $LANDBASE_PROXY 

LANDRESOURCE_PROXY=$(dappProxy src/proxy/LandResourceProxy.sol:LandResourceProxy)
info "LandResourceProxy inited."

LANDRESOURCEV6=$(dappCreate land contracts/LandResourceV6.sol:LandResourceV6)
seth send $LANDRESOURCE_PROXY "upgradeTo(address)" $LANDRESOURCEV6
if test $(seth call $LANDRESOURCE_PROXY "implementation()(address)") != $LANDRESOURCEV6; then
  (echo "check migration failed."; exit 1;)
fi
#resource release start time 1544083267
starttime=$(seth --to-uint256 $(date +%s))
seth send $LANDRESOURCE_PROXY "initializeContract(address,uint256)" $SETTINGSREGISTRY $starttime  

info "migration finished." 

landrsId=$(seth --to-bytes32 $(seth --from-ascii "CONTRACT_LAND_RESOURCE"))
seth send $SETTINGSREGISTRY "setAddressProperty(bytes32,address)" $landrsId $LANDRESOURCE_PROXY 

# mysteriousTreasure
MYSTERIOUSTREASURE=$(dappCreate land contracts/MysteriousTreasure.sol:MysteriousTreasure)
info "MysteriousTreasure created."

MYSTERIOUSTREASURE_PROXY=$(dapp create MysteriousTreasureProxy)
info "MysteriousTreasureProxy created."

# gold: 8077
# wood: 25440
# water: 5320
# fire: 1060
# earth: 10118
# 10439, 419, 5258, 12200, 12200
resources=[$(seth --to-uint256 8077),$(seth --to-uint256 25440),$(seth --to-uint256 5320),$(seth --to-uint256 1060),$(seth --to-uint256 10118)]
seth send $MYSTERIOUSTREASURE_PROXY "upgradeTo(address)" $MYSTERIOUSTREASURE  
seth send $MYSTERIOUSTREASURE_PROXY "initializeContract(address,uint256[5])" $SETTINGSREGISTRY $resources 
treasureId=$(seth --to-bytes32 $(seth --from-ascii "CONTRACT_MYSTERIOUS_TREASURE"))
seth send $SETTINGSREGISTRY "setAddressProperty(bytes32,address)" $treasureId $MYSTERIOUSTREASURE_PROXY 
